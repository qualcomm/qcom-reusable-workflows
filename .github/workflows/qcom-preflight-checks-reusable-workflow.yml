name: Qualcomm Preflight Checks Reusable Workflow
on:
  workflow_call:
    inputs:
      repolinter:
        required: false
        type: boolean
        default: true
      semgrep: 
        required: false
        type: boolean
        default: true
      semgrep-cli-options:
        required: false
        type: string
        default: ''
        description: 'Additional CLI options to pass to semgrep scan command'
      copyright-license-detector:
        required: false
        type: boolean
        default: true
      pr-check-emails:
        required: false
        type: boolean
        default: true
      dependency-review:
        required: false
        type: boolean
        default: true      

permissions:
  contents: read
  security-events: write
  
jobs:
  repolinter:
    if: ${{ inputs.repolinter && (github.event_name == 'push' || github.event_name == 'pull_request') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
      - name: Verify repolinter config file is present
        id: check_files
        uses: andstor/file-existence-action@v3
        with:
          files: "repolint.json"
      - name: Run Repolinter with local repolint.json
        if: steps.check_files.outputs.files_exists == 'true'
        uses: todogroup/repolinter-action@v1
        with:
          config_file: "repolint.json"
      - name: Run Repolinter with default ruleset
        if: steps.check_files.outputs.files_exists == 'false'
        uses: todogroup/repolinter-action@v1
        with:
          config_url: "https://raw.githubusercontent.com/qualcomm/.github/main/repolint.json"

  semgrep-static-analysis:
    if: ${{ inputs.semgrep && (github.event_name == 'push' || github.event_name == 'pull_request') && github.actor != 'dependabot[bot]' }}
    name: semgrep/ci
    runs-on: ubuntu-latest

    container:
      image: semgrep/semgrep:1.125.0
    steps:
      - name: checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history to properly detect changes
          ref: ${{ github.event.pull_request.head.sha }}  # Explicitly checkout the PR code
      
      - name: Files to scan
        id: changed-files
        run: |
          git config --global --add safe.directory "$(pwd)"
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA=${{ github.event.pull_request.base.sha }}
            HEAD_SHA=${{ github.event.pull_request.head.sha }}
            
            echo "Changed files between $BASE_SHA and $HEAD_SHA:"
            # Get list of changed files
            git diff --name-only $BASE_SHA $HEAD_SHA > changed_files.txt
            
            # Filter out files matching patterns in .semgrepignore
            if [ -f ".semgrepignore" ]; then
              echo "Filtering files based on .semgrepignore patterns"
              cat changed_files.txt | grep -v -f .semgrepignore > filtered_files.txt || touch filtered_files.txt
            else
              cp changed_files.txt filtered_files.txt
            fi
            
            # Set environment variable with filtered files
            FILTERED_FILES=$(cat filtered_files.txt | tr '\n' ' ')
            echo "CHANGED_FILES=$FILTERED_FILES" >> $GITHUB_ENV
            echo "Files to scan after filtering: $FILTERED_FILES"
            
            # Clean up temporary files
            rm -f changed_files.txt filtered_files.txt
          else
            # For pushes to main, scan all files
            echo "CHANGED_FILES=." >> $GITHUB_ENV
            echo "Scanning all files on main branch"
          fi
      
      - name: Check for semgrep config file
        id: check_semgrep_config
        run: |
          if [ -f ".semgrep.yml" ] || [ -f ".semgrep/semgrep.yml" ]; then
            echo "SEMGREP_CONFIG=--config ." >> $GITHUB_ENV
            echo "Using repository's semgrep configuration"
          else
            echo "SEMGREP_CONFIG=--config auto" >> $GITHUB_ENV
            echo "Using default semgrep configuration"
          fi
          
          # Check for .semgrepignore file
          if [ -f ".semgrepignore" ]; then
            echo "Found .semgrepignore file - Semgrep will automatically use it to exclude files from scanning"
            echo "SEMGREP_IGNORE_FILE_EXISTS=true" >> $GITHUB_ENV
          else
            echo "No .semgrepignore file found - Semgrep will use default exclusions"
            echo "SEMGREP_IGNORE_FILE_EXISTS=false" >> $GITHUB_ENV
          fi
      
      - name: Display Semgrep Configuration
        run: |
          echo "Semgrep Configuration:"
          echo "  - Config: $SEMGREP_CONFIG"
          echo "  - .semgrepignore file: $SEMGREP_IGNORE_FILE_EXISTS"
          echo "  - Additional CLI options: ${{ inputs.semgrep-cli-options != '' && inputs.semgrep-cli-options || 'none' }}"
          
      - name: Run Semgrep scan on matching files
        shell: bash
        run: |
          if [ -n "$CHANGED_FILES" ]; then
            semgrep scan $SEMGREP_CONFIG --sarif --output semgrep.sarif ${{ inputs.semgrep-cli-options != '' && inputs.semgrep-cli-options || '' }} $CHANGED_FILES
          else
            echo "No files found to scan"
            echo "[]" > semgrep.json
            echo '{"runs": []}' > semgrep.sarif
          fi
      
      - name: Upload SARIF to github
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
          category: semgrep
  copyright-license-check:
    if: ${{ ( inputs.copyright-license-detector && contains('pull_request', github.event_name) && github.event.action != 'closed' ) }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history so we can diff properly
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
 
      - name: Add PR base repo as remote and fetch it
        run: |
          git remote add upstream https://github.com/${{ github.event.pull_request.base.repo.full_name }}.git
          git fetch upstream
 
      - name: Generate final patch between base and head
        run: |
          git diff upstream/${{ github.event.pull_request.base.ref }} > pr.patch
          head -n 100 pr.patch

      - name: Run copyright/license detector
        uses: qualcomm/copyright-license-checker-action@v1.0.0
        with:
          patch_file: pr.patch
          repo_name: ${{ github.repository }}
  
  commit-emails-check:
    if: ${{ inputs.pr-check-emails && (github.event_name == 'push' || github.event_name == 'pull_request')}}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Check PR emails
        uses: qualcomm/commit-emails-check-action@v1.0.0

  dependency-review:
    if: ${{ inputs.dependency-review && (github.event_name == 'push' || github.event_name == 'pull_request')}}
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4
      - name: Set base ref and head ref
        id: setrefs
        run: |
          if [ "${{github.event_name}}" == "push" ]; then
            echo "base_ref=${{ github.event.before }}" >> $GITHUB_OUTPUT
            echo "head_ref=${{ github.sha }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "pull_request_target" ]; then
            echo "base_ref=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
            echo "head_ref=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          fi
      - name: 'Dependency Review'
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
