name: Qualcomm Preflight Checks Reusable Workflow
on:
  workflow_call:
    inputs:
      repolinter:
        required: false
        type: boolean
        default: true
      semgrep: 
        required: false
        type: boolean
        default: true
      semgrep-cli-options:
        required: false
        type: string
        default: '--config auto'
        description: 'CLI options for semgrep scan (e.g., "--config p/security-audit --severity ERROR"). Must be valid CLI flags only.'
      copyright-license-detector:
        required: false
        type: boolean
        default: true
      pr-check-emails:
        required: false
        type: boolean
        default: true
      dependency-review:
        required: false
        type: boolean
        default: true  
      commit-msg-check:
        required: false
        type: boolean
        default: false
      sub-char-limit:
        required: false
        type: number
        default: 50
        description: 'Maximum characters allowed in commit subject line'
      body-char-limit:
        required: false
        type: number
        default: 72
        description: 'Maximum characters allowed per line in commit body'
      check-blank-line:
        required: false
        type: boolean
        default: true
        description: 'Ensures a blank line between the commit subject, body, and Signed-off-by signature'
        
permissions:
  contents: read
  security-events: write
  
jobs:
  repolinter:
    if: ${{ inputs.repolinter && (github.event_name == 'push' || github.event_name == 'pull_request') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
      - name: Verify repolinter config file is present
        id: check_files
        uses: andstor/file-existence-action@v3
        with:
          files: "repolint.json"
      - name: Run Repolinter with local repolint.json
        if: steps.check_files.outputs.files_exists == 'true'
        uses: todogroup/repolinter-action@v1
        with:
          config_file: "repolint.json"
      - name: Run Repolinter with default ruleset
        if: steps.check_files.outputs.files_exists == 'false'
        uses: todogroup/repolinter-action@v1
        with:
          config_url: "https://raw.githubusercontent.com/qualcomm/.github/main/repolint.json"

  semgrep-static-analysis:
    if: ${{ inputs.semgrep && (github.event_name == 'push' || github.event_name == 'pull_request') && github.actor != 'dependabot[bot]' }}
    name: semgrep/ci
    runs-on: ubuntu-latest

    env:
      # Use baseline scanning for PRs to scan only changes
      SEMGREP_BASELINE_REF: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.sha || '' }}
      SEMGREP_REPO_NAME: ${{ github.repository }}
      SEMGREP_COMMIT: ${{ github.sha }}
      SEMGREP_CLI_OPTIONS: ${{ inputs.semgrep-cli-options }}

    container:
      image: semgrep/semgrep:1.125.0
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.sha }}
      
      - name: Configure git
        run: git config --global --add safe.directory "$(pwd)"
      
      - name: Run Semgrep
        run: |
          # Run semgrep with only the options passed by consuming workflow
          # No auto-detection, no default config - consuming workflow must specify rules
          semgrep scan --sarif --output semgrep.sarif $SEMGREP_CLI_OPTIONS
      
      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: semgrep.sarif
          category: semgrep

  copyright-license-check:
    if: ${{ ( inputs.copyright-license-detector && github.event_name == 'pull_request' && github.event.action != 'closed' ) }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR head
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history so we can diff properly
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
 
      - name: Add PR base repo as remote and fetch it
        run: |
          git remote add upstream https://github.com/${{ github.event.pull_request.base.repo.full_name }}.git
          git fetch upstream
 
      - name: Generate final patch between base and head
        run: |
          git diff upstream/${{ github.event.pull_request.base.ref }} > pr.patch
          head -n 100 pr.patch

      - name: Run copyright/license detector
        uses: qualcomm/copyright-license-checker-action@v1.0.0
        with:
          patch_file: pr.patch
          repo_name: ${{ github.repository }}
  
  commit-emails-check:
    if: ${{ inputs.pr-check-emails && (github.event_name == 'push' || github.event_name == 'pull_request')}}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Check PR emails
        uses: qualcomm/commit-emails-check-action@v1.0.0

  dependency-review:
    if: ${{ inputs.dependency-review && (github.event_name == 'push' || github.event_name == 'pull_request')}}
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4
      - name: Set base ref and head ref
        id: setrefs
        run: |
          if [ "${{github.event_name}}" == "push" ]; then
            echo "base_ref=${{ github.event.before }}" >> $GITHUB_OUTPUT
            echo "head_ref=${{ github.sha }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "base_ref=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
            echo "head_ref=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          fi
      - name: 'Dependency Review'
        uses: actions/dependency-review-action@v4
        with:
          base-ref: ${{ steps.setrefs.outputs.base_ref }}
          head-ref: ${{ steps.setrefs.outputs.head_ref }}
          fail-on-severity: high  

  commit-msg-check:
    if: ${{ inputs.commit-msg-check && github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - name: Run custom commit check
        uses: qualcomm/commit-msg-check-action@v1.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          body-char-limit: ${{ inputs.body-char-limit }}
          sub-char-limit: ${{ inputs.sub-char-limit }}
          check-blank-line: ${{ inputs.check-blank-line }}
