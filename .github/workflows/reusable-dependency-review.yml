name: Dependency Review Reusable Workflow
on:
  workflow_call:  

permissions:
  contents: read
  

jobs:
  detect-dependency-review-support:
    name: Detect Dependency Review support
    runs-on: ubuntu-latest
    outputs:
      dep_review_supported: ${{ steps.check.outputs.dep_review_supported }}
    steps:
      - name: Probe SBOM endpoint
        id: check
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          echo "Checking SBOM (dependency graph) availability for ${{ github.repository }}..."

          sbom_status=$(curl -s -o /dev/null -w '%{http_code}' \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/dependency-graph/sbom")

          supported=false
          if [ "$sbom_status" = "200" ] || [ "$sbom_status" = "202" ]; then
            supported=true
            echo "✅ SBOM endpoint available (status: $sbom_status). Dependency Review supported."
          else
            echo "⚠️ SBOM endpoint unavailable (status: $sbom_status). Skipping Dependency Review."
          fi

          # Log diagnostics
          echo "::group::Diagnostics"
          echo "sbom_http: $sbom_status"
          echo "::endgroup::"

          echo "dep_review_supported=$supported" >> "$GITHUB_OUTPUT"

  run-dependency-review:
    name: Run Dependency Review
    needs: detect-dependency-review-support
    if: ${{ needs.detect-dependency-review-support.outputs.dep_review_supported == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      - name: Set base ref and head ref
        id: setrefs
        run: |
          if [ "${{github.event_name}}" == "push" ]; then
            echo "base_ref=${{ github.event.before }}" >> $GITHUB_OUTPUT
            echo "head_ref=${{ github.sha }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "base_ref=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
            echo "head_ref=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          fi
      - name: Run Dependency Review Action
        uses: actions/dependency-review-action@v4
        with:
          base-ref: ${{ steps.setrefs.outputs.base_ref }}
          head-ref: ${{ steps.setrefs.outputs.head_ref }}
          fail-on-severity: critical
